# WebRTC Recorder

Цей проєкт є сервісом для запису WebRTC медіа потоків. Він приймає вхідні WebRTC сесії, записує їх у відеофайл, виконує транскодування та завантажує результат у файлове сховище.

## Архітектура та Технології

Сервіс побудований на мові **Go** та використовує наступні ключові технології:

-   **WebRTC:** [Pion](https://github.com/pion/webrtc) - для обробки WebRTC сесій.
-   **API:** [gRPC](https://grpc.io/) - для комунікації з сервісом. Усі API методи визначені за допомогою Protocol Buffers.
-   **Service Discovery:** [Consul](https://www.consul.io/) - для реєстрації та знаходження сервісу в мікросервісній архітектурі.
-   **База даних:** [PostgreSQL](https://www.postgresql.org/) - для зберігання метаданих про сесії запису та файли.
-   **Конфігурація:** [Viper](https://github.com/spf13/viper) - для керування конфігурацією додатку.
-   **Dependency Injection:** [Google Wire](https://github.com/google/wire) - для автоматичної генерації коду ініціалізації залежностей.

## Структура Проєкту

-   **/cmd**: Основний вхідний пакет програми. Ініціалізує конфігурацію, логування та запускає сервіс.
-   **/config**: Модуль для роботи з конфігурацією (читання з файлів або змінних середовища).
-   **/gen**: Автоматично згенерований код на основі `.proto` файлів (клієнти та сервери gRPC, моделі даних).
-   **/infra**: Клієнти для взаємодії з зовнішніми сервісами (Consul, PostgreSQL, gRPC, Storage).
-   **/internal**: Внутрішня логіка додатку, яка не повинна експортуватися.
    -   **/handler**: gRPC хендлери, які обробляють вхідні запити.
    -   **/model**: Основні структури даних (моделі) проєкту.
    -   **/service**: Бізнес-логіка сервісу (керування сесіями, транскодування, завантаження файлів).
    -   **/store**: Логіка для взаємодії з базою даних.
-   **/deploy**: Приклади файлів для розгортання (наприклад, `systemd` unit).
-   **/buf**: Конфігураційні файли для [Buf](https://buf.build/), інструменту для роботи з Protocol Buffers.

## Початок роботи

### Передумови

-   [Go](https://golang.org/dl/) (версія 1.21 або вище)
-   [PostgreSQL](https://www.postgresql.org/download/)
-   [Consul](https://www.consul.io/downloads)
-   [FFmpeg](https://ffmpeg.org/download.html) (для транскодування)

### Конфігурація

Сервіс можна конфігурувати за допомогою змінних середовища або конфігураційного файлу. Приклад конфігурації можна знайти у `config/config.go`.

Основні параметри:
-   Адреса gRPC сервера
-   Параметри підключення до PostgreSQL
-   Параметри підключення до Consul
-   Налаштування для файлового сховища

### Запуск

1.  **Клонуйте репозиторій:**
    ```bash
    git clone https://github.com/webitel/webrtc_recorder.git
    cd webrtc_recorder
    ```

2.  **Встановіть залежності:**
    ```bash
    go mod tidy
    ```

3.  **Запустіть сервіс:**
    ```bash
    go run main.go [command options]
    ```
    Або за допомогою змінних середовища.

### Параметри запуску

Параметри можна передавати як через прапори командного рядка, так і через змінні середовища.

#### **Cache**
| Прапор | Змінна середовища | Опис | Значення за замовчуванням |
| --- | --- | --- | --- |
| `--cache-dir` | `CACHE_TEMP_DIR` | Директорія для тимчасового кешу файлів | `./temp` |

#### **Database**
| Прапор | Змінна середовища | Опис | Значення за замовчуванням |
| --- | --- | --- | --- |
| `--postgresql-dsn` | `DATA_SOURCE` | Рядок підключення до PostgreSQL | `postgres://postgres:postgres@localhost:5432/webitel?sslmode=disable` |

#### **Server**
| Прапор | Змінна середовища | Опис | Значення за замовчуванням |
| --- | --- | --- | --- |
| `--bind-address`, `-b` | `BIND_ADDRESS` | Адреса для внутрішніх комунікацій кластера | `localhost:50011` |
| `--consul-discovery`, `-c` | `CONSUL` | Адреса service discovery (Consul) | `127.0.0.1:8500` |
| `--service-id`, `-i` | `ID` | Ідентифікатор сервісу | `1` |

#### **Transcoding**
| Прапор | Змінна середовища | Опис | Значення за замовчуванням |
| --- | --- | --- | --- |
| `--transcoding-max-retry` | `TRANSCODING_MAX_RETRY` | Кількість повторних спроб транскодування | `10` |
| `--transcoding-queue` | `TRANSCODING_QUEUE` | Розмір черги на транскодування | `1` |
| `--transcoding-workers` | `TRANSCODING_WORKERS` | Кількість воркерів для транскодування | `4` |

#### **Uploader**
| Прапор | Змінна середовища | Опис | Значення за замовчуванням |
| --- | --- | --- | --- |
| `--uploader-max-retry` | `UPLOADER_MAX_RETRY` | Кількість повторних спроб завантаження | `20` |
| `--uploader-queue` | `UPLOADER_QUEUE` | Розмір черги на завантаження | `2` |
| `--uploader-workers` | `UPLOADER_WORKERS` | Кількість воркерів для завантаження | `10` |

#### **WebRTC**
| Прапор | Змінна середовища | Опис | Значення за замовчуванням |
| --- | --- | --- | --- |
| `--webrtc-codecs` | `WEBRTC_CODECS` | Підтримувані кодеки | `video/VP9`, `video/H264` |
| `--webrtc-ice-disconnect-timeout` | `WEBRTC_ICE_DISCONNECT_TIMEOUT` | Таймаут роз'єднання ICE | `5s` |
| `--webrtc-ice-failed-timeout` | `WEBRTC_ICE_FAILED_TIMEOUT` | Таймаут помилки ICE | `15s` |
| `--webrtc-ice-keepalive-timeout` | `WEBRTC_ICE_KEEPALIVE_TIMEOUT` | Таймаут підтримки з'єднання ICE | `5s` |
| `--webrtc-udp-port-range` | `WEBRTC_UDP_PORT_RANGE` | Діапазон UDP портів | `10000-20000` |

## API

Сервіс надає gRPC API, визначене у файлі `protos/webrtc.proto`. Основний сервіс `WebRTCService` керує життєвим циклом запису WebRTC сесій.

### Сервіс `WebRTCService`

#### `UploadP2PVideo`

Цей метод ініціює нову сесію запису. Клієнт надсилає SDP Offer, а у відповідь отримує SDP Answer від сервера для встановлення WebRTC з'єднання.

-   **Запит (`UploadP2PVideoRequest`):**
    -   `sdp_offer`: SDP пропозиція від клієнта.
    -   `name`: Назва для майбутнього запису.
    -   `uuid`: Унікальний ідентифікатор сесії.
    -   `ice_servers`: Список ICE серверів для встановлення з'єднання.
-   **Відповідь (`UploadP2PVideoResponse`):**
    -   `sdp_answer`: SDP відповідь від сервера.
    -   `id`: Унікальний ідентифікатор сесії запису на сервері.

#### `StopP2PVideo`

Зупиняє активну сесію запису за її ідентифікатором.

-   **Запит (`StopP2PVideoRequest`):**
    -   `id`: Ідентифікатор сесії, яку потрібно зупинити.
-   **Відповідь (`StopP2PVideoResponse`):** Порожня.

#### `RenegotiateP2PVideo`

Дозволяє оновити медіа-параметри (re-negotiate) для існуючої сесії запису. Це може бути необхідно, наприклад, при зміні мережевих умов.

-   **Запит (`RenegotiateP2PVideoRequest`):**
    -   `id`: Ідентифікатор сесії.
    -   `sdp_offer`: Нова SDP пропозиція від клієнта.
-   **Відповідь (`RenegotiateP2PVideoResponse`):**
    -   `sdp_answer`: Нова SDP відповідь від сервера.

Для взаємодії з API використовуйте згенеровані gRPC клієнти для вашої мови програмування.

## Розгортання

У директорії `deploy/systemd` знаходиться приклад `systemd` unit файлу для запуску сервісу на Linux системах.
